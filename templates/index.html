<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ভিডিও ডাউনলোডার ও ড্রপবক্স আপলোডার</title>
    <style>
        /* আগের CSS কোড এখানে থাকবে */
        body { font-family: sans-serif; line-height: 1.6; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], input[type="url"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        button[type="submit"] { display: block; width: 100%; padding: 12px; background-color: #5cb85c; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
        button[type="submit"]:hover { background-color: #4cae4c; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .results-container { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; min-height: 50px; /* Prevents layout shift */ }
        #processing-indicator { display: none; text-align: center; padding: 10px; margin-top: 15px; font-style: italic; color: #555; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; margin: 10px auto; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Input Mode Specific Groups - Initially hide link and merge */
        #direct-link-group, #merge-group { display: none; }
        .radio-group label { display: inline-block; margin-right: 10px; font-weight: normal; }
        .error-message { color: red; font-size: 0.9em; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ভিডিও ডাউনলোডার ও ড্রপবক্স আপলোডার</h1>

        <div id="ajax-error-message" class="error-message"></div>

        <form method="POST" id="download-form">
            <div class="form-group radio-group">
                <strong>ইনপুট মোড নির্বাচন করুন:</strong><br>
                <input type="radio" id="mode_uid" name="input_mode" value="uid" checked onchange="toggleInputMode()">
                <label for="mode_uid">UID</label>
                <input type="radio" id="mode_link" name="input_mode" value="link" onchange="toggleInputMode()">
                <label for="mode_link">সরাসরি লিঙ্ক</label>
                <input type="radio" id="mode_merge" name="input_mode" value="merge" onchange="toggleInputMode()">
                <label for="mode_merge">ভিডিও+অডিও মার্জ</label>
            </div>

            <div id="uid-group">
                <div class="form-group"> <label for="uid">UID:</label> <input type="text" id="uid" name="uid"> </div>
                <div class="form-group"> <label for="number">ফাইলের সংখ্যা:</label> <input type="number" id="number" name="number" min="1"> </div>
            </div>

            <div id="direct-link-group">
                <div class="form-group"> <label for="direct_link">ভিডিওর সরাসরি লিঙ্ক:</label> <input type="url" id="direct_link" name="direct_link" placeholder="https://..."> </div>
            </div>

            <div id="merge-group">
                <div class="form-group"> <label for="video_link">ভিডিও লিঙ্ক (অডিও ছাড়া):</label> <input type="url" id="video_link" name="video_link" placeholder="https://..."> </div>
                <div class="form-group"> <label for="audio_link">অডিও লিঙ্ক:</label> <input type="url" id="audio_link" name="audio_link" placeholder="https://..."> </div>
            </div>

            <div class="form-group"> <label for="category">ক্যাটাগরি:</label> <select id="category" name="category" required> <option value="movie">Movie</option> <option value="episode">Episode</option> <option value="drama movies">Drama Movies</option> <option value="drama">Drama</option> </select> </div>
            <div class="form-group"> <label for="folder_1_name">প্রথম ফোল্ডারের নাম:</label> <input type="text" id="folder_1_name" name="folder_1_name" required> </div>
            <div class="form-group"> <label for="folder_2_name">দ্বিতীয় ফোল্ডারের নাম:</label> <input type="text" id="folder_2_name" name="folder_2_name" required> </div>

            <button type="submit" id="submit-button">প্রসেস শুরু করুন</button>
        </form>

        <div id="processing-indicator"> <p>প্রসেসিং চলছে...</p> <div class="spinner"></div> </div>

        <div id="results-container" class="results-container">
            </div>
    </div>

    <script>
        function toggleInputMode() {
            const mode = document.querySelector('input[name="input_mode"]:checked').value;
            const uidGroup = document.getElementById('uid-group');
            const linkGroup = document.getElementById('direct-link-group');
            const mergeGroup = document.getElementById('merge-group');
            const uidInput = document.getElementById('uid');
            const numberInput = document.getElementById('number');
            const linkInput = document.getElementById('direct_link');
            const videoLinkInput = document.getElementById('video_link');
            const audioLinkInput = document.getElementById('audio_link');

            // Hide all mode-specific groups initially
            uidGroup.style.display = 'none';
            linkGroup.style.display = 'none';
            mergeGroup.style.display = 'none';

            // Disable requirements for all optional fields
            uidInput.required = false;
            numberInput.required = false;
            linkInput.required = false;
            videoLinkInput.required = false;
            audioLinkInput.required = false;

            // Show the selected group and set requirements
            if (mode === 'uid') {
                uidGroup.style.display = 'block';
                uidInput.required = true;
                numberInput.required = true;
            } else if (mode === 'link') {
                linkGroup.style.display = 'block';
                linkInput.required = true;
            } else if (mode === 'merge') {
                mergeGroup.style.display = 'block';
                videoLinkInput.required = true;
                audioLinkInput.required = true;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            toggleInputMode(); // Set initial state

            const form = document.getElementById('download-form');
            const submitButton = document.getElementById('submit-button');
            const processingIndicator = document.getElementById('processing-indicator');
            const resultsContainer = document.getElementById('results-container');
            const ajaxErrorMessage = document.getElementById('ajax-error-message');

            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission
                ajaxErrorMessage.textContent = ''; // Clear previous errors
                resultsContainer.innerHTML = ''; // Clear previous results
                processingIndicator.style.display = 'block'; // Show spinner
                submitButton.disabled = true;
                submitButton.textContent = 'প্রসেসিং চলছে...';

                const formData = new FormData(form);

                fetch('/', { // Send request to the same URL
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message from response body if possible
                        return response.text().then(text => {
                           throw new Error(`সার্ভার এরর: ${response.status} ${response.statusText}. ${text}`);
                        });
                    }
                    return response.text(); // Get response as HTML text
                })
                .then(html => {
                    resultsContainer.innerHTML = html; // Update results area
                    // Re-enable copy button functionality if needed (or use event delegation)
                })
                .catch(error => {
                    console.error('AJAX Error:', error);
                    ajaxErrorMessage.textContent = `একটি ত্রুটি ঘটেছে: ${error.message}`;
                    resultsContainer.innerHTML = '<p style="color:red; text-align:center;">ফলাফল লোড করা যায়নি।</p>';
                })
                .finally(() => {
                    processingIndicator.style.display = 'none'; // Hide spinner
                    submitButton.disabled = false;
                    submitButton.textContent = 'প্রসেস শুরু করুন';
                     // Scroll to results
                    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        });

        // Note: copyToClipboard function needs to be available or re-attached
        // if results are dynamically loaded. Using event delegation on resultsContainer
        // is a more robust approach. For simplicity, we keep the old function.
        // If copy doesn't work, this needs adjustment.
        function copyToClipboard(elementId, button) {
            const linkText = document.getElementById(elementId)?.innerText; // Add null check
            if (!linkText) {
                console.error("Could not find element with ID:", elementId);
                return;
            }
            navigator.clipboard.writeText(linkText).then(() => {
                const originalText = button.innerText;
                button.innerText = 'কপি হয়েছে!';
                button.disabled = true;
                setTimeout(() => {
                    button.innerText = originalText;
                     button.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('লিঙ্ক কপি করতে সমস্যা হয়েছে।');
            });
        }

    </script>
</body>
</html>
